#!/usr/bin/env node
/**
 * ChatGPT Code Review Script
 *
 * PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  ChatGPTë¥¼ í†µí•´ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 *
 * Environment Variables:
 * - CHATGPT_API_KEY: OpenAI API key (required)
 * - PR_NUMBER: Pull request number
 * - PR_TITLE: Pull request title
 * - PR_AUTHOR: Pull request author
 * - BASE_BRANCH: Base branch name
 * - HEAD_BRANCH: Head branch name
 * - FILES_COUNT: Number of changed files
 * - ADDITIONS: Number of added lines
 * - DELETIONS: Number of deleted lines
 */

import { readFile, writeFile } from 'fs/promises';
import { existsSync } from 'fs';

const CHATGPT_API_URL = 'https://api.openai.com/v1/chat/completions';
const CHATGPT_MODEL = 'gpt-4o';  // ë˜ëŠ” 'gpt-4-turbo', 'gpt-3.5-turbo'

/**
 * ChatGPT API í˜¸ì¶œ
 */
async function callChatGPT(messages, temperature = 0.3) {
  const apiKey = process.env.CHATGPT_API_KEY;

  if (!apiKey) {
    throw new Error('CHATGPT_API_KEY environment variable is required');
  }

  const response = await fetch(CHATGPT_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: CHATGPT_MODEL,
      messages,
      temperature,
      max_tokens: 4000,
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`ChatGPT API error: ${response.status} ${error}`);
  }

  const data = await response.json();
  return data.choices[0].message.content;
}

/**
 * 7-Phase Code Review ìˆ˜í–‰
 */
async function performCodeReview(prInfo, changedFiles) {
  console.log('Starting 7-Phase Code Review...');

  // ë³€ê²½ ë‚´ìš© ìš”ì•½
  const filesSummary = changedFiles.map(f =>
    `- ${f.filename} (${f.status}): +${f.additions} -${f.deletions}`
  ).join('\n');

  // íŒ¨ì¹˜ ë‚´ìš© (diff) ì¤€ë¹„
  const patchContent = changedFiles
    .filter(f => f.patch)
    .slice(0, 10)  // ìµœëŒ€ 10ê°œ íŒŒì¼ë§Œ (í† í° ì œí•œ)
    .map(f => `File: ${f.filename}\n\`\`\`diff\n${f.patch}\n\`\`\``)
    .join('\n\n');

  // ChatGPTì—ê²Œ ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸
  const systemPrompt = `You are an expert code reviewer performing a systematic 7-phase review.
Be thorough but constructive. Focus on:
- Code quality and best practices
- Security vulnerabilities
- Performance issues
- Test coverage
- Documentation
- Maintainability

Format your response in the following structure:
## Phase 1: Scope & Intent
## Phase 2: File-by-File Analysis
## Phase 3: Integration Points
## Phase 4: Testing & Coverage
## Phase 5: Documentation
## Phase 6: Security & Performance
## Phase 7: Best Practices

## Final Verdict
- Verdict: APPROVE | REQUEST_CHANGES | COMMENT
- Critical Issues: [list]
- Recommendations: [list]`;

  const userPrompt = `Please review this Pull Request:

**PR #${prInfo.number}: ${prInfo.title}**
Author: ${prInfo.author}
Branch: ${prInfo.headBranch} â†’ ${prInfo.baseBranch}

**Changes Summary:**
- ${prInfo.filesCount} files changed
- +${prInfo.additions} -${prInfo.deletions} lines

**Files Changed:**
${filesSummary}

**Code Changes (Diff):**
${patchContent}

Please perform a comprehensive 7-phase review and provide your verdict.`;

  const messages = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ];

  const reviewContent = await callChatGPT(messages);

  console.log('Review completed!');
  return reviewContent;
}

/**
 * ë¦¬ë·° ê²°ê³¼ íŒŒì‹± ë° verdict ì¶”ì¶œ
 */
function parseReviewResult(reviewContent) {
  // Verdict ì¶”ì¶œ
  let verdict = 'COMMENT';  // ê¸°ë³¸ê°’

  if (reviewContent.includes('Verdict: APPROVE') ||
      reviewContent.includes('Final Verdict: APPROVE')) {
    verdict = 'APPROVE';
  } else if (reviewContent.includes('Verdict: REQUEST_CHANGES') ||
             reviewContent.includes('Final Verdict: REQUEST_CHANGES') ||
             reviewContent.includes('REQUEST CHANGES')) {
    verdict = 'REQUEST_CHANGES';
  }

  // ìš”ì•½ ìƒì„±
  const summary = `# ğŸ¤– ChatGPT Code Review

${reviewContent}

---

*Generated by ChatGPT Code Review Bot*
*Model: ${CHATGPT_MODEL}*
`;

  return {
    verdict,
    summary,
    inline_comments: []  // í–¥í›„ í™•ì¥: íŠ¹ì • ë¼ì¸ì— ëŒ€í•œ ì½”ë©˜íŠ¸
  };
}

/**
 * Main
 */
async function main() {
  try {
    // PR ì •ë³´ ìˆ˜ì§‘
    const prInfo = {
      number: process.env.PR_NUMBER || 'unknown',
      title: process.env.PR_TITLE || 'Unknown PR',
      author: process.env.PR_AUTHOR || 'unknown',
      baseBranch: process.env.BASE_BRANCH || 'main',
      headBranch: process.env.HEAD_BRANCH || 'unknown',
      filesCount: parseInt(process.env.FILES_COUNT || '0'),
      additions: parseInt(process.env.ADDITIONS || '0'),
      deletions: parseInt(process.env.DELETIONS || '0'),
    };

    console.log('PR Info:', prInfo);

    // ë³€ê²½ëœ íŒŒì¼ ì •ë³´ ì½ê¸°
    if (!existsSync('changed-files.json')) {
      throw new Error('changed-files.json not found');
    }

    const changedFiles = JSON.parse(await readFile('changed-files.json', 'utf8'));
    console.log(`Reviewing ${changedFiles.length} files...`);

    // ë„ˆë¬´ í° PRì€ ê²½ê³ 
    if (changedFiles.length > 50 || prInfo.additions + prInfo.deletions > 2000) {
      console.warn('âš ï¸ Large PR detected. Review might be incomplete.');
      console.warn('Recommendation: Split into smaller PRs for better review quality.');
    }

    // ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰
    const reviewContent = await performCodeReview(prInfo, changedFiles);

    // ê²°ê³¼ íŒŒì‹±
    const result = parseReviewResult(reviewContent);

    // ê²°ê³¼ ì €ì¥
    await writeFile('chatgpt-review-result.json', JSON.stringify(result, null, 2));

    console.log('âœ… Review completed successfully');
    console.log('Verdict:', result.verdict);

    process.exit(0);
  } catch (error) {
    console.error('âŒ Review failed:', error.message);
    console.error(error.stack);

    // ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ ì½”ë©˜íŠ¸ ìƒì„±
    const fallbackResult = {
      verdict: 'COMMENT',
      summary: `# âš ï¸ ChatGPT Code Review Failed

An error occurred during automated review:
\`\`\`
${error.message}
\`\`\`

Please perform manual review.`,
      inline_comments: []
    };

    await writeFile('chatgpt-review-result.json', JSON.stringify(fallbackResult, null, 2));

    process.exit(1);
  }
}

main();
