name: gemini-spec-manager

# GeminiÎ•º ÏÇ¨Ïö©Ìïú Î™ÖÏÑ∏ Í¥ÄÎ¶¨ Î∞è Spec Drift Ï≤¥ÌÅ¨
# Issue ÏÉùÏÑ± Ïãú ‚Üí ÏûêÎèô Î™ÖÏÑ∏ ÏÉùÏÑ±
# PR ÏÉùÏÑ± Ïãú ‚Üí Spec Drift Ï≤¥ÌÅ¨

on:
  issues:
    types: [opened, labeled, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  # Job 1: Issue Î∂ÑÏÑù Î∞è Î™ÖÏÑ∏ ÏÉùÏÑ±
  analyze-issue:
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'opened'

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check if Gemini enabled
        id: check_enabled
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::GEMINI_API_KEY not configured. Skipping Gemini analysis."
            echo "::warning::To enable: Settings ‚Üí Secrets ‚Üí New secret ‚Üí GEMINI_API_KEY"
            echo "::warning::Get API key from: https://ai.google.dev/"
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Gemini Issue Analysis
        if: steps.check_enabled.outputs.enabled == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Analyzing Issue #${ISSUE_NUMBER}..."
          node scripts/gemini-analyze-issue.mjs

      - name: Create Spec Update PR
        if: steps.check_enabled.outputs.enabled == 'true' && hashFiles('spec-updates/**') != ''
        uses: peter-evans/create-pull-request@v5
        with:
          title: "[GEMINI] spec: ${{ github.event.issue.title }}"
          branch: gemini/spec-update-${{ github.event.issue.number }}
          commit-message: "[GEMINI] spec: update for issue #${{ github.event.issue.number }}"
          body-path: spec-pr-body.md
          labels: specification, gemini-generated

      - name: Update Claude Inbox
        if: steps.check_enabled.outputs.enabled == 'true' && hashFiles('prompts/P*.md') != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INBOX_ISSUE_NUMBER: ${{ vars.CLAUDE_INBOX_ISSUE_NUMBER }}
        run: |
          echo "Updating Claude Inbox..."
          node scripts/update-claude-inbox.mjs

      - name: Summary
        run: |
          echo "## Gemini Issue Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_enabled.outputs.enabled }}" = "true" ]; then
            echo "‚úÖ Gemini analysis completed" >> $GITHUB_STEP_SUMMARY
            if [ -f spec-pr-body.md ]; then
              echo "‚úÖ Specification PR created" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -d prompts ] && ls prompts/P*.md 1> /dev/null 2>&1; then
              echo "‚úÖ Prompts generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Gemini analysis skipped (API key not configured)" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Spec Drift Ï≤¥ÌÅ¨
  spec-drift-check:
    if: github.event_name == 'pull_request'

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run Spec Drift Check
        id: drift_check
        run: |
          echo "Running spec drift check..."
          node scripts/spec-drift-check.mjs > drift-result.txt || true

          if grep -q "drift: 0" drift-result.txt; then
            echo "drift=0" >> $GITHUB_OUTPUT
          else
            echo "drift=1" >> $GITHUB_OUTPUT
          fi

      - name: Check if Gemini enabled
        id: check_enabled
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Gemini Drift Analysis
        if: steps.check_enabled.outputs.enabled == 'true' && steps.drift_check.outputs.drift == '1'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Analyzing spec drift with Gemini..."
          node scripts/gemini-analyze-drift.mjs

      - name: Post Drift Analysis
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üìä Spec Drift Check\n\n';

            // Drift Í≤∞Í≥º ÏùΩÍ∏∞
            try {
              const driftResult = fs.readFileSync('drift-result.txt', 'utf8');
              comment += '```\n' + driftResult + '\n```\n\n';
            } catch (e) {
              comment += '‚ö†Ô∏è Could not read drift results\n\n';
            }

            // Gemini Î∂ÑÏÑù ÏùΩÍ∏∞ (ÏûàÏúºÎ©¥)
            try {
              const analysis = JSON.parse(fs.readFileSync('drift-analysis.json', 'utf8'));
              comment += '### ü§ñ Gemini Analysis\n\n';
              comment += analysis.comment || 'No analysis available';
            } catch (e) {
              comment += '*Gemini analysis not available (API key not configured)*\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: comment
            });

      - name: Summary
        run: |
          echo "## Spec Drift Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.drift_check.outputs.drift }}" = "0" ]; then
            echo "‚úÖ No spec drift detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Spec drift detected - please review" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Manual Gemini Analysis (ÏΩîÎ©òÌä∏ Ìä∏Î¶¨Í±∞)
  manual-analysis:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/gemini analyze')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check if Gemini enabled
        id: check_enabled
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Gemini Analysis
        if: steps.check_enabled.outputs.enabled == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          PR_NUMBER: ${{ github.event.issue.pull_request && github.event.pull_request.number || '' }}
          PR_TITLE: ${{ github.event.issue.pull_request && github.event.pull_request.title || '' }}
        run: |
          if [ "${{ github.event.issue.pull_request }}" ]; then
            echo "Analyzing PR..."
            node scripts/gemini-analyze-drift.mjs
          else
            echo "Analyzing Issue..."
            node scripts/gemini-analyze-issue.mjs
          fi

      - name: Post Results
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ü§ñ Gemini Analysis\n\n';

            try {
              const analysis = JSON.parse(fs.readFileSync('gemini-analysis.json', 'utf8'));
              comment += analysis.comment || 'Analysis completed';
            } catch (e) {
              comment += '‚ö†Ô∏è Analysis failed: ' + e.message;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: comment
            });

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Not Enabled Warning
        if: steps.check_enabled.outputs.enabled == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: '‚ö†Ô∏è Gemini API key not configured. Please add `GEMINI_API_KEY` to repository secrets.\n\nGet API key from: https://ai.google.dev/'
            });

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });
