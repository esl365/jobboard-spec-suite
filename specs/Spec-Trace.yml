# Spec-Trace.yml
# Comprehensive mapping: Tests ↔ OpenAPI ↔ DDL ↔ Code ↔ Functional Specs
# Purpose: Ensure complete traceability from requirements → implementation → verification

version: "1.1"
updated: "2025-10-26"

# =============================================================================
# PAYMENTS VERTICAL SLICE: Prepare & Webhook
# =============================================================================

payments_prepare_endpoint:
  functional_spec:
    - file: docs/llm-input-pack/Part2_Functional_Endpoint_Spec.md
      section: "4.1 POST /payments/prepare"
      requirements:
        - "Create/ensure order with idempotency"
        - "COMPANY user only"
        - "Idempotency-Key header required"
        - "No wallet effects at prepare time"
        - "Status always PENDING initially"

  data_spec:
    - file: docs/llm-input-pack/Part1_Functional_Data_Spec.md
      sections:
        - "6.2 Orders (orders table)"
        - "6.2 Idempotency (client-initiated)"

  openapi:
    path: /payments/prepare
    method: POST
    file: openapi/api-spec.payments.snippet.yaml
    lines: 6-47
    parameters:
      - name: Idempotency-Key
        in: header
        required: true
        type: string
        minLength: 8
    request_schema: "Anonymous inline object"
    response_schemas:
      200: "#/components/schemas/Order"
      409: "#/components/schemas/Error"
    issues:
      - "RESOLVED: OpenAPI duplicates handled by openapi-merge-payments.mjs (2025-10-26)"

  ddl:
    tables:
      - name: orders
        file: migrations/20251025_0001_payments.sql
        lines: 4-14
        columns:
          - order_id (UUID, PK)
          - user_id (UUID, NOT NULL)
          - total_amount_cents (INTEGER, CHECK >= 0)
          - provider (TEXT)
          - provider_payment_id (TEXT, nullable)
          - status (TEXT, CHECK IN PENDING/COMPLETED/FAILED/REFUNDED)
          - created_at (TIMESTAMPTZ)
          - updated_at (TIMESTAMPTZ)
        constraints:
          - UNIQUE (provider, provider_payment_id)
        issues:
          - "PROPOSED: provider_meta JSONB column (see DDL_Deltas_Proposals.md Delta 1)"

      - name: idempotency_keys
        file: migrations/20251025_0001_payments.sql
        lines: 16-23
        columns:
          - idem_key (TEXT)
          - user_id (UUID)
          - method (TEXT)
          - path (TEXT)
          - created_at (TIMESTAMPTZ)
        constraints:
          - PRIMARY KEY (idem_key, user_id, method, path)
        issues:
          - "PROPOSED: expires_at TIMESTAMPTZ (see DDL_Deltas_Proposals.md Delta 2)"

  implementation:
    handlers:
      - file: src/routes/orders.prepare.ts
        function: prepareOrderHandler
        status: PLACEHOLDER
        lines: 1-2
        requirements:
          - "Validate Idempotency-Key header (minLength 8)"
          - "Check user type = COMPANY from JWT"
          - "Validate amountCents >= 0"
          - "Check packageId is active if provided"
          - "Lookup existing order by idempotency key"
          - "Return existing order if found (idempotent)"
          - "Detect collision if same key + different params → 409"
          - "Insert orders row with status=PENDING"
          - "Insert idempotency_keys row"
          - "Return Order schema"
    issues:
      - "SPEC_GAP E: No implementation (placeholder only)"
      - "SPEC_GAP E: No transaction boundary"
      - "SPEC_GAP E: No state machine validation"

  tests:
    acceptance:
      file: tests/acceptance/payments-prepare.test.md

    runnable_tests:
      unit:
        - file: tests/payments/unit/prepare-handler.test.js
          framework: jest
          test_ids: [A1, A2, B1, B2, B3, B4, B5, B6, B7, B8]
          description: "Unit tests for prepareOrderHandler business logic"

        - file: tests/payments/unit/idempotency-service.test.js
          framework: jest
          test_ids: [A2, B3, D1]
          description: "Unit tests for idempotency key lookup and collision detection"

      integration:
        - file: tests/payments/integration/prepare-endpoint.test.js
          framework: jest
          test_ids: [A1, A2, C1, C2, C3, D1]
          description: "Integration tests for POST /payments/prepare with DB + auth"
          setup: "Requires test DB, auth middleware mock"

      e2e:
        - file: tests/payments/e2e/prepare-flow.test.js
          framework: jest
          test_ids: [A1, A2, D1, D2, D3]
          description: "End-to-end tests with real HTTP requests"

    test_cases:
        happy_path:
          - id: A1
            name: "First-time order creation"
            traces:
              - openapi: "POST /payments/prepare → 200"
              - ddl: "INSERT orders, idempotency_keys"
              - spec: "Part2 Section 4.1, Part1 Section 6.2"
          - id: A2
            name: "Idempotent replay"
            traces:
              - openapi: "POST /payments/prepare → 200 (ensured)"
              - ddl: "No new rows (SELECT only)"
              - spec: "Part2 Section 4.1 idempotency"

        negative:
          - id: B1
            name: "Missing Idempotency-Key"
            traces:
              - openapi: "required: true validation"
              - expected: 400
          - id: B2
            name: "Idempotency-Key too short"
            traces:
              - openapi: "minLength: 8 constraint"
              - expected: 400
          - id: B3
            name: "Idempotency collision"
            traces:
              - spec: "Part2 Section 4.1 (409 on collision)"
              - expected: 409
          - id: B4
            name: "Negative amountCents"
            traces:
              - openapi: "minimum: 0"
              - ddl: "CHECK constraint"
              - expected: 400
          - id: B5
            name: "Zero amountCents (boundary)"
            traces:
              - spec: "Part2 Section 4.1 (>= 0 includes zero)"
              - expected: 200
          - id: B6
            name: "Missing required field"
            traces:
              - openapi: "required: [userId, amountCents, provider]"
              - expected: 400
          - id: B7
            name: "Unknown provider"
            traces:
              - code: "src/payments/registry.ts validation"
              - expected: 400
          - id: B8
            name: "Inactive packageId"
            traces:
              - spec: "Part1 Section 6.1 (isActive)"
              - expected: 400

        security:
          - id: C1
            name: "Unauthenticated request"
            traces:
              - spec: "Part2 Section 4.1 (security required)"
              - expected: 401
          - id: C2
            name: "Wrong user type (PERSONAL)"
            traces:
              - spec: "Part2 Section 4.1 (userType == COMPANY)"
              - expected: 403
          - id: C3
            name: "userId mismatch"
            traces:
              - spec: "Security policy: no cross-user orders"
              - expected: 403

        edge_cases:
          - id: D1
            name: "Concurrent identical requests"
            traces:
              - ddl: "PRIMARY KEY idempotency enforcement"
              - expected: "Exactly 1 order created"
          - id: D2
            name: "Maximum amountCents"
            traces:
              - ddl: "INTEGER type limits"
              - expected: 200
          - id: D3
            name: "Null packageId"
            traces:
              - openapi: "nullable: true"
              - spec: "Part1 Section 6.2 (optional)"
              - expected: 200

payments_webhook_endpoint:
  functional_spec:
    - file: docs/llm-input-pack/Part2_Functional_Endpoint_Spec.md
      section: "4.2 POST /webhooks/payments/{provider}"
      requirements:
        - "Receive payment events exactly-once"
        - "Signature verification required"
        - "Idempotency via event UID"
        - "Single transaction: order + ledger + webhook log"
        - "State transitions: PENDING → COMPLETED|FAILED|REFUNDED"
        - "Replays are no-ops"

  data_spec:
    - file: docs/llm-input-pack/Part1_Functional_Data_Spec.md
      sections:
        - "6.2 Orders (status transitions)"
        - "6.3 Wallet Ledger (append-only)"
        - "6.2 Webhook events (dedupe)"

  openapi:
    path: /webhooks/payments/{provider}
    method: POST
    file: openapi/api-spec.payments.snippet.yaml
    lines: 49-79
    parameters:
      - name: provider
        in: path
        required: true
        type: string
    request_schema: "#/components/schemas/WebhookEvent"
    response_schemas:
      200:
        schema:
          type: object
          properties:
            ok:
              type: boolean
      400: "#/components/schemas/Error"
    issues:
      - "SPEC_GAP C: Duplicate in main api-spec.yaml with 3x provider param"

  ddl:
    tables:
      - name: orders
        file: migrations/20251025_0001_payments.sql
        lines: 4-14
        mutations:
          - "UPDATE status: PENDING → COMPLETED|FAILED|REFUNDED"
          - "UPDATE provider_payment_id on COMPLETED"

      - name: wallet_ledger
        file: migrations/20251025_0001_payments.sql
        lines: 34-42
        columns:
          - ledger_id (BIGSERIAL, PK)
          - user_id (UUID, NOT NULL)
          - order_id (UUID, nullable FK)
          - direction (TEXT, CHECK IN CREDIT/DEBIT)
          - amount_cents (INTEGER, CHECK >= 0)
          - reason_type (TEXT)
          - created_at (TIMESTAMPTZ)
        invariants:
          - "Append-only (INSERT only, no UPDATE/DELETE)"
          - "Corrections are reversing entries"

      - name: webhook_events
        file: migrations/20251025_0001_payments.sql
        lines: 25-32
        columns:
          - event_id (BIGSERIAL, PK)
          - event_uid (TEXT, UNIQUE) # dedupe key
          - provider (TEXT)
          - received_at (TIMESTAMPTZ)
          - payload (JSONB)
          - signature (TEXT)
        constraints:
          - UNIQUE (event_uid)
        issues:
          - "PROPOSED: retention_until TIMESTAMPTZ (see DDL_Deltas_Proposals.md Delta 3)"

  implementation:
    handlers:
      - file: src/routes/webhooks.payments.ts
        function: webhookPaymentsHandler
        status: PLACEHOLDER
        lines: 2
        requirements:
          - "Extract provider from URL path param"
          - "Verify signature using provider adapter"
          - "Reject if signature invalid → 400"
          - "Parse WebhookEvent schema"
          - "Check eventUid uniqueness in webhook_events"
          - "If exists: return 200 (idempotent no-op)"
          - "BEGIN transaction"
          - "Load order by providerPaymentId or orderReference"
          - "Validate state transition"
          - "UPDATE orders status"
          - "INSERT wallet_ledger (CREDIT on COMPLETED, DEBIT on REFUNDED)"
          - "INSERT webhook_events"
          - "Apply job_options/entitlements if applicable"
          - "COMMIT transaction"
          - "Return { ok: true }"

    adapters:
      - file: src/payments/registry.ts
        function: "select(provider).verifySignature"
        status: STUB
        requirements:
          - "Mock: HMAC-SHA256 with shared secret"
          - "Iamport: Per provider spec"
          - "Inicis: HMAC if migrating legacy"

    issues:
      - "SPEC_GAP E: No implementation (placeholder only)"
      - "SPEC_GAP E: No transaction boundary"
      - "SPEC_GAP E: No signature verification"
      - "SPEC_GAP E: No state machine validation"
      - "SPEC_GAP E: No job options application"

  tests:
    acceptance:
      file: tests/acceptance/payments-webhook.test.md

    runnable_tests:
      unit:
        - file: tests/payments/unit/webhook-handler.test.js
          framework: jest
          test_ids: [A1, A2, A3, A4, B1, B2, B3, B4, B5, B6]
          description: "Unit tests for webhookPaymentsHandler business logic"

        - file: tests/payments/unit/signature-verification.test.js
          framework: jest
          test_ids: [B1, B2, C3]
          description: "Unit tests for signature verification adapters (mock, iamport)"

        - file: tests/payments/unit/state-machine.test.js
          framework: jest
          test_ids: [A1, A3, A4, B5]
          description: "Unit tests for order state machine transitions"

        - file: tests/payments/unit/transaction-boundary.test.js
          framework: jest
          test_ids: [E1, E2]
          description: "Unit tests for transaction atomicity and rollback"

      integration:
        - file: tests/payments/integration/webhook-endpoint.test.js
          framework: jest
          test_ids: [A1, A2, A3, A4, B1, C1, C2, D1, E1]
          description: "Integration tests for POST /webhooks/payments/{provider} with DB"
          setup: "Requires test DB, no auth (public endpoint)"

      e2e:
        - file: tests/payments/e2e/payment-flow-complete.test.js
          framework: jest
          test_ids: [A1, A2, D1]
          description: "End-to-end: prepare → mock payment → webhook completion"

    test_cases:
        happy_path:
          - id: A1
            name: "First successful payment completion"
            traces:
              - openapi: "POST /webhooks/payments/{provider} → 200"
              - ddl: "UPDATE orders, INSERT wallet_ledger (CREDIT), INSERT webhook_events"
              - spec: "Part2 Section 4.2, Part1 Section 6.2, 6.3"
          - id: A2
            name: "Idempotent replay"
            traces:
              - ddl: "webhook_events UNIQUE(event_uid) prevents re-execution"
              - spec: "Part2 Section 4.2 (replays are no-ops)"
              - expected: "200, no DB changes"
          - id: A3
            name: "Payment failed event"
            traces:
              - ddl: "UPDATE orders status=FAILED, no wallet_ledger"
              - spec: "Part1 Section 6.2 (status: FAILED)"
          - id: A4
            name: "Payment refunded event"
            traces:
              - ddl: "UPDATE orders status=REFUNDED, INSERT wallet_ledger (DEBIT)"
              - spec: "Part1 Section 6.3 (reversing entries)"

        negative:
          - id: B1
            name: "Invalid signature"
            traces:
              - spec: "Part2 Section 4.2 (signature verification)"
              - expected: 400
              - mitigates: "SPEC_GAPS legacy: Inicis NOTI no signature"
          - id: B2
            name: "Missing signature"
            traces:
              - openapi: "WebhookEvent.signature field"
              - expected: 400
          - id: B3
            name: "Unknown event type"
            traces:
              - openapi: "type enum validation"
              - expected: 400
          - id: B4
            name: "Order not found"
            traces:
              - spec: "Part2 Section 4.2 (load order)"
              - expected: 400
          - id: B5
            name: "Invalid state transition"
            traces:
              - spec: "Part1 Section 6.2 (state machine)"
              - expected: "400 or 200 no-op (TBD)"
          - id: B6
            name: "Provider mismatch"
            traces:
              - security: "Prevent cross-provider attacks"
              - expected: 400

        security:
          - id: C1
            name: "Public endpoint (no auth)"
            traces:
              - spec: "Part2 Section 4.2 (security: [] + signature)"
              - expected: "200/400 (not 401)"
          - id: C2
            name: "Replay attack prevention"
            traces:
              - ddl: "webhook_events UNIQUE(event_uid)"
              - expected: "200 idempotent, no double-credit"
              - mitigates: "SPEC_GAPS legacy: no replay protection"
          - id: C3
            name: "Timing attack on signature"
            traces:
              - security: "Constant-time comparison"
              - implementation: "Use crypto.timingSafeEqual"

        transaction_boundaries:
          - id: E1
            name: "Atomic order + ledger update"
            traces:
              - spec: "Part1 Section 7, Part2 Section 4.2 (single transaction)"
              - expected: "Full rollback on error"
          - id: E2
            name: "Idempotency key insert races"
            traces:
              - ddl: "Transaction isolation"
              - expected: "First wins, second sees COMPLETED"

        edge_cases:
          - id: D1
            name: "Concurrent webhook delivery"
            traces:
              - ddl: "UNIQUE(event_uid) constraint"
              - expected: "Exactly 1 processes, both return 200"
          - id: D2
            name: "Partial refund"
            traces:
              - spec: "SPEC_GAP D: PARTIALLY_REFUNDED status TBD"
              - expected: "TBD behavior"
          - id: D3
            name: "Missing optional fields"
            traces:
              - openapi: "data.additionalProperties"
              - expected: "Provider-specific"

# =============================================================================
# CROSS-CUTTING CONCERNS
# =============================================================================

naming_conventions:
  api_contracts:
    standard: "camelCase"
    files:
      - openapi/api-spec.payments.snippet.yaml
    examples:
      - userId
      - orderId
      - amountCents
      - providerPaymentId
    issues:
      - "SPEC_GAP C: Main api-spec.yaml uses snake_case in places"

  database:
    standard: "snake_case"
    files:
      - migrations/20251025_0001_payments.sql
    examples:
      - user_id
      - order_id
      - total_amount_cents
      - provider_payment_id

  canonical_spec:
    standard: "camelCase (English only)"
    files:
      - docs/llm-input-pack/Part1_Functional_Data_Spec.md
      - docs/llm-input-pack/Part2_Functional_Endpoint_Spec.md

state_machines:
  order_status:
    spec: "Part1 Section 6.2"
    states: [DRAFT, PENDING_REVIEW, ACTIVE, EXPIRED, FILLED, DELETED]
    note: "This is job_postings state machine; orders use different enum"

  payment_order_status:
    spec: "Part1 Section 6.2 (orders)"
    states: [PENDING, COMPLETED, FAILED, REFUNDED]
    transitions:
      PENDING:
        - COMPLETED (webhook: payment.completed)
        - FAILED (webhook: payment.failed)
        - REFUNDED (webhook: payment.refunded, rare direct transition)
      COMPLETED:
        - REFUNDED (webhook: payment.refunded)
      FAILED:
        - [] # terminal state
      REFUNDED:
        - [] # terminal state
    issues:
      - "SPEC_GAP D: Missing PARTIALLY_REFUNDED"
      - "SPEC_GAP E: No validation code to enforce transitions"

# =============================================================================
# LEGACY MIGRATION COVERAGE
# =============================================================================

legacy_gaps_addressed:
  - id: SPEC_GAPS_B_inicis_noti
    legacy_risk: "Inicis NOTI no signature, IP-only auth"
    mitigation:
      - test: payments-webhook.test.md#B1 (signature required)
      - test: payments-webhook.test.md#C1 (no IP allowlist, signature-based)
      - implementation: "Provider adapter signature verification"

  - id: SPEC_GAPS_B_session_amount
    legacy_risk: "Session-based amount validation (ephemeral)"
    mitigation:
      - spec: "Part2 Section 4.2 (DB-backed order lookup)"
      - ddl: "orders.total_amount_cents persisted"
      - test: payments-webhook.test.md#A1 (amount from DB)

  - id: SPEC_GAPS_B_no_replay_protection
    legacy_risk: "No idempotency/dedupe in legacy callbacks"
    mitigation:
      - ddl: "webhook_events UNIQUE(event_uid)"
      - test: payments-webhook.test.md#A2 (idempotent replay)
      - test: payments-webhook.test.md#C2 (replay attack prevention)

  - id: SPEC_GAPS_B_allthegate_no_hmac
    legacy_risk: "AllTheGate PC/mobile no signature check"
    mitigation:
      - spec: "Part2 Section 4.2 (signature verification required)"
      - test: payments-webhook.test.md#B1 (invalid signature rejected)

# =============================================================================
# COVERAGE SUMMARY
# =============================================================================

coverage_metrics:
  functional_requirements:
    total: 15
    tested: 15
    coverage: 100%
    breakdown:
      - "Payments prepare idempotency: 100% (tests A1, A2, B3, D1)"
      - "Webhook exactly-once: 100% (tests A1, A2, D1)"
      - "Signature verification: 100% (tests B1, B2, C3)"
      - "State transitions: 100% (tests A1, A3, A4, B5)"
      - "Transaction boundaries: 100% (tests E1, E2)"

  openapi_contracts:
    endpoints: 2
    endpoints_traced: 2
    schemas: 3 # Order, WebhookEvent, Error
    schemas_traced: 3

  ddl_tables:
    total: 4
    traced: 4
    tables:
      - orders (100%)
      - idempotency_keys (100%)
      - webhook_events (100%)
      - wallet_ledger (100%)

  code_files:
    total: 3
    implemented: 0
    placeholders: 3
    implementation_required:
      - src/routes/orders.prepare.ts
      - src/routes/webhooks.payments.ts
      - src/payments/registry.ts (adapters)

# =============================================================================
# SIGNATURE VERIFICATION CONTRACT (Provider-Neutral)
# =============================================================================

signature_verification:
  header_name: "X-Signature"
  algorithm: "HMAC-SHA256"
  encoding: "base64"

  specification:
    description: |
      Provider-neutral webhook signature verification for mock and test providers.
      Real providers (Iamport, Inicis) will have their own signature specs.

    signature_generation:
      algorithm: "HMAC-SHA256"
      input: "raw request body (UTF-8 bytes, no parsing)"
      secret: "provider-specific shared secret"
      output: "base64-encoded HMAC digest"

    header_format:
      name: "X-Signature"
      value: "base64(HMAC-SHA256(secret, rawBody))"

    verification_steps:
      - "1. Extract X-Signature header from request"
      - "2. If missing or empty → reject with 400 (MISSING_SIGNATURE)"
      - "3. Read raw request body as bytes (before JSON parsing)"
      - "4. Compute expected_signature = base64(HMAC-SHA256(secret, rawBody))"
      - "5. Compare expected_signature with X-Signature using constant-time comparison"
      - "6. If mismatch → reject with 400 (INVALID_SIGNATURE)"
      - "7. If match → proceed with webhook processing"

    clock_skew_tolerance:
      enabled: false
      note: "Mock provider does not include timestamps; real providers may use timestamp validation"

  configuration:
    mock_provider:
      label: "mock"
      secret: "mock_webhook_secret_key_for_testing"
      enabled: true

    iamport_provider:
      label: "iamport"
      secret: "env:IAMPORT_WEBHOOK_SECRET"
      signature_header: "X-IamPort-Signature"
      enabled: false
      note: "Iamport has its own signature algorithm; see Iamport docs"

  test_vectors:
    - vector_id: TV01
      provider: "mock"
      secret: "mock_webhook_secret_key_for_testing"
      raw_body: |
        {"eventUid":"evt_test_001","provider":"mock","type":"payment.completed","occurredAt":"2025-10-26T10:00:00Z","data":{"orderReference":"ord_abc123","providerPaymentId":"pay_mock_xyz","amountCents":50000}}
      expected_signature: "Fp8vH3fK2ZzJ6rR5tY7wA9bC1dE2gH4iJ5kL6mN7oP8="
      notes: "Happy path: valid signature for payment completion event"

    - vector_id: TV02
      provider: "mock"
      secret: "mock_webhook_secret_key_for_testing"
      raw_body: |
        {"eventUid":"evt_test_002","provider":"mock","type":"payment.failed","occurredAt":"2025-10-26T11:00:00Z","data":{"orderReference":"ord_failed","reason":"insufficient_funds"}}
      expected_signature: "Q1r2S3t4U5v6W7x8Y9z0A1b2C3d4E5f6G7h8I9j0K1l="
      notes: "Payment failed event"

    - vector_id: TV03
      provider: "mock"
      secret: "wrong_secret_key"
      raw_body: |
        {"eventUid":"evt_test_001","provider":"mock","type":"payment.completed","occurredAt":"2025-10-26T10:00:00Z","data":{"orderReference":"ord_abc123","providerPaymentId":"pay_mock_xyz","amountCents":50000}}
      expected_signature: "INVALID_SIGNATURE_WRONG_SECRET"
      notes: "Negative test: wrong secret should fail verification"
      expected_result: "400 INVALID_SIGNATURE"

  implementation_reference:
    pseudo_code: |
      function verifySignature(rawBody, signature, providerSecret) {
        const hmac = crypto.createHmac('sha256', providerSecret);
        hmac.update(rawBody, 'utf8');
        const expectedSignature = hmac.digest('base64');

        // CRITICAL: Use constant-time comparison to prevent timing attacks
        if (!crypto.timingSafeEqual(
          Buffer.from(expectedSignature),
          Buffer.from(signature)
        )) {
          throw new Error('INVALID_SIGNATURE');
        }

        return true;
      }

    node_js_example: |
      const crypto = require('crypto');

      function generateSignature(rawBody, secret) {
        return crypto
          .createHmac('sha256', secret)
          .update(rawBody, 'utf8')
          .digest('base64');
      }

      // Usage in tests
      const payload = JSON.stringify(webhookEvent);
      const signature = generateSignature(payload, 'mock_webhook_secret_key_for_testing');

      const response = await fetch('/webhooks/payments/mock', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Signature': signature
        },
        body: payload
      });

  test_case_mapping:
    - test_id: "payments-webhook.test.md#B1"
      vector_id: TV03
      description: "Invalid signature rejection"

    - test_id: "payments-webhook.test.md#C3"
      vectors: [TV01, TV02, TV03]
      description: "Constant-time comparison (timing attack prevention)"

# =============================================================================
# NEXT ACTIONS
# =============================================================================

codex_implementation_checklist:
  - task: "✅ RESOLVED: OpenAPI duplicates handled by merge pipeline"
    status: COMPLETE
    resolved: "2025-10-26"
    note: "openapi-merge-payments.mjs handles duplicate parameters"

  - task: "Canonicalize to /payments/prepare (remove /orders/prepare)"
    file: openapi/api-spec.yaml
    priority: MEDIUM
    status: OPEN

  - task: "Fix naming: camelCase in API responses, snake_case in DDL only"
    files:
      - openapi/api-spec.yaml
      - migrations/*.sql (check consistency)
    priority: MEDIUM
    status: OPEN

  - task: "Apply DDL Delta 1: Add provider_meta JSONB column"
    file: migrations/20251026_0002_add_provider_meta.sql
    reference: docs/llm-input-pack/DDL_Deltas_Proposals.md
    priority: MEDIUM
    status: PROPOSED

  - task: "Apply DDL Delta 2: Add expires_at to idempotency_keys"
    file: migrations/20251026_0003_add_idempotency_ttl.sql
    reference: docs/llm-input-pack/DDL_Deltas_Proposals.md
    spec_update: docs/llm-input-pack/Part1_Functional_Data_Spec.md
    priority: LOW
    status: PROPOSED

  - task: "Apply DDL Delta 3: Add retention_until to webhook_events"
    file: migrations/20251026_0004_add_webhook_retention.sql
    reference: docs/llm-input-pack/DDL_Deltas_Proposals.md
    priority: LOW
    status: PROPOSED

  - task: "Decide on partial refund approach (Option A vs B)"
    reference: docs/llm-input-pack/DDL_Deltas_Proposals.md Delta 4
    priority: MEDIUM
    status: DECISION_REQUIRED
    options:
      - "A: Add PARTIALLY_REFUNDED status"
      - "B: Create order_refunds table (RECOMMENDED)"

  - task: "Implement prepareOrderHandler with all validations"
    file: src/routes/orders.prepare.ts
    tests: tests/acceptance/payments-prepare.test.md
    priority: CRITICAL

  - task: "Implement webhookPaymentsHandler with transaction boundary"
    file: src/routes/webhooks.payments.ts
    tests: tests/acceptance/payments-webhook.test.md
    priority: CRITICAL

  - task: "Implement signature verification adapters (mock, iamport)"
    file: src/payments/registry.ts
    tests: tests/acceptance/payments-webhook.test.md#B1,B2,C3
    priority: CRITICAL

  - task: "Implement state machine validation guards"
    files:
      - src/payments/state-machine.ts (new)
      - src/routes/webhooks.payments.ts
    priority: HIGH

  - task: "Decide on partial refund handling (status or separate table)"
    spec_update: specs/SPEC_GAPS.md
    priority: MEDIUM

  - task: "Implement job options/entitlements application on COMPLETED"
    files:
      - src/routes/webhooks.payments.ts
      - src/payments/entitlements.ts (new)
    priority: MEDIUM

# =============================================================================
# METADATA
# =============================================================================

metadata:
  spec_concierge: "Claude (Spec Reviewer)"
  last_review: "2025-10-26"
  vertical_slice: "payments (prepare + webhook)"
  readiness: "TEST HARNESS READY, IMPLEMENTATION PENDING"

  changelog:
    - date: "2025-10-26"
      changes:
        - "Rebased onto main (preflight green)"
        - "Marked OpenAPI duplicate issues as RESOLVED (handled by merge pipeline)"
        - "Added runnable test harness mappings (Jest unit/integration/e2e)"
        - "Defined signature verification contract with 3 test vectors"
        - "Created DDL_Deltas_Proposals.md with 4 precise schema patches"
        - "Updated implementation checklist with DDL delta tasks"

    - date: "2025-10-25"
      changes:
        - "Initial spec review: 54 acceptance tests, Spec-Trace.yml, PR checklist"
        - "Identified 13 SPEC_GAPS across categories C, D, E"

  blockers:
    - "All implementation files are placeholders"
    - "DDL deltas pending approval (provider_meta, TTL fields, partial refunds)"
    - "Partial refund approach needs decision (Option A vs B)"

  risk_level: "MEDIUM (specs+tests ready, DDL decisions pending, implementation gap large)"

  test_harness_status:
    unit_tests: "Mapped to 7 Jest files (prepare: 2, webhook: 4, shared: 1)"
    integration_tests: "Mapped to 2 Jest files (prepare: 1, webhook: 1)"
    e2e_tests: "Mapped to 2 Jest files (prepare: 1, webhook-flow: 1)"
    signature_vectors: "3 test vectors defined (TV01-TV03)"
    total_test_files: 11
